{% extends "base.html" %}
{% block title %}Login{% endblock %}

{% block content %}
<section class="auth-wrapper">
  <div class="auth-card">
    <!-- LEFT: Illustration panel (50%) -->
    <aside class="auth-aside">
      <!-- Welcome text section -->
      <div class="auth-welcome">
        <h2>Welcome back</h2>
        <p>Sign in to manage songs, rooms, and ChordPro sheets.</p>
      </div>
      <div class="auth-illustration">
        <img src="{{ url_for('static', filename='img/login_side.png') }}" alt="Welcome to HOPEKCC Chord Pro Tool" />
      </div>
    </aside>

    <!-- RIGHT: Login form (50%) -->
    <div class="auth-form-container">
      <div class="auth-form">
        <h1 class="auth-title">Login</h1>
        <div id="error-msg" class="auth-error"></div>

        <!-- Email / Password Login -->
        <form id="login-form" class="login-form">
          <div class="form-group">
            <label class="input-label" for="email">Email</label>
            <div class="input-group">
              <input type="email" id="email" placeholder="you@example.com" required />
            </div>
          </div>

          <div class="form-group">
            <label class="input-label" for="password">Password</label>
            <div class="input-group">
              <input type="password" id="password" placeholder="your password" required />
              <button type="button" class="toggle-pass" onclick="togglePass()">Show</button>
            </div>
          </div>

          <button type="submit" class="btn-primary auth-submit">Login</button>
        </form>

        <!-- Divider line -->
        <div style="display:flex; align-items:center; gap:12px; margin:16px 0;">
          <hr style="flex:1; border:none; border-top:1px solid #e5e7eb;">
          <span style="color:#6b7280; font-size:14px;">or</span>
          <hr style="flex:1; border:none; border-top:1px solid #e5e7eb;">
        </div>

        <!-- Google Login button -->
        <button id="google-login"
          style="display:flex; align-items:center; justify-content:center; gap:10px;
                 width:100%; height:48px; border:1px solid #d1d5db; border-radius:8px;
                 background:#fff; cursor:pointer; font-weight:600;">
          <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true">
            <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.6 32.4 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.8 3l5.7-5.7C34.9 6 29.7 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.7-.4-3.5z"/>
            <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 16.6 19 14 24 14c3 0 5.7 1.1 7.8 3l5.7-5.7C34.9 6 29.7 4 24 4 15.5 4 8.2 8.8 6.3 14.7z"/>
            <path fill="#4CAF50" d="M24 44c5.1 0 9.8-2 13.2-5.2l-6.1-5.2C29 35.6 26.6 36 24 36c-5.1 0-9.5-3.6-11-8.5l-6.6 5.1C8.2 39.2 15.5 44 24 44z"/>
            <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1 3.1-3.2 5.6-6.1 7.1l6.1 5.2C38.4 37.6 44 31.6 44 24c0-1.3-.1-2.7-.4-3.5z"/>
          </svg>
          Continue with Google
        </button>

      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  function togglePass() {
    const el = document.getElementById('password');
    const btn = document.querySelector('.toggle-pass');
    if (el.type === 'password') {
      el.type = 'text';
      btn.textContent = 'Hide';
    } else {
      el.type = 'password';
      btn.textContent = 'Show';
    }
  }
</script>

<!-- Firebase frontend logic with inline config -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  const app = initializeApp({ /* your config (unchanged) */ 
    apiKey: "AIzaSyAQ3r-8kqsWOgBkWRKs-bApV33oeu-AICs",
    authDomain: "hopekcc-2024-summer-intern-api.firebaseapp.com",
    projectId: "hopekcc-2024-summer-intern-api",
    storageBucket: "hopekcc-2024-summer-intern-api.appspot.com",
    messagingSenderId: "172531116306",
    appId: "1:172531116306:web:d898ae28b5f79a425babcb"
  });
  const auth = getAuth(app);

  async function exchangeSessionCookie(idToken) {
    const r = await fetch("/sessionLogin", {
      method: "POST",
      credentials: "include",                 // <-- IMPORTANT so Set-Cookie is stored
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ idToken })
    });
    if (!r.ok) throw new Error(`sessionLogin failed: ${r.status}`);
  }
                            
  // EMAIL/PASSWORD
  document.getElementById("login-form")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const cred = await signInWithEmailAndPassword(auth, email, password);
    const idToken = await cred.user.getIdToken(true);
    await exchangeSessionCookie(idToken);
    window.location.href = "/";               // redirect AFTER cookie is set
  });

  // GOOGLE
  document.getElementById("google-login")?.addEventListener("click", async () => {
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth, provider);
    const idToken = await result.user.getIdToken(true);
    await exchangeSessionCookie(idToken);
    window.location.href = "/";               // redirect AFTER cookie is set
  });
</script>
{% endblock %}