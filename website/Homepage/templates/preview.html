
{% extends 'base.html' %}

{% block title %}Song PDF Preview{% endblock %}

{% block content %}
<div class="welcome-section">
  <div class="welcome-text">
    <h1>Song PDF Preview</h1>

    <!-- Enter song_id -->
    <form id="songid-form" method="get" action="{{ url_for('preview') }}" style="margin-bottom:1rem;">
      <label for="song_id"><strong>Song ID</strong></label>  <!-- removed stray text -->
      <input
        type="text"
        id="song_id"
        name="song_id"
        placeholder="e.g. 3 or a UUID"
        value="{{ request.args.get('song_id', '') }}"
        style="width:280px;margin-left:0.5rem;"
        required
      />
      <button type="submit" class="btn-primary" style="margin-left:0.5rem;">Show PDF</button>
    </form>

    <!--<details style="margin:1rem 0;">
      <summary>Paste ChordPro (optional)</summary>
      <form method="post" style="margin-top:0.75rem;">
        <textarea name="chordpro_text" rows="10" cols="60" placeholder="Paste your ChordPro content here..."></textarea>
        <br><br>
        <button type="submit" class="btn-primary">Render Preview</button>
      </form>
    </details>-->
  </div>
</div>

<!-- PDF viewer (render ALWAYS so JS can update it even on first load) -->
<div class="welcome-section">
  <div class="welcome-text">
    <h2>Preview Output</h2>

      <p style="margin:0 0 0.5rem 0;">
        Now showing:
        <span id="now-song" style="font-weight:600;">—</span>
      </p>

    <iframe
      id="pdf-frame"
      title="ChordPro PDF"
      width="100%"
      height="640"
      style="border:1px solid #e5e7eb;border-radius:8px;background:#fff"
      src="">
    </iframe>

    <p id="pdf-hint" style="color:#2b2f78;margin-top:0.5rem;">
      If it doesn’t load, make sure you’re signed in and that this song exists on the backend.
    </p>

    {% if content %}
      <h3 style="margin-top:1.5rem;">Raw ChordPro Preview</h3>
      <pre style="background-color:#f0f0f0;padding:1rem;border-radius:5px;">{{ content }}</pre>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAQ3r-8kqsWOgBkWRKs-bApV33oeu-AICs",
    authDomain: "hopekcc-2024-summer-intern-api.firebaseapp.com",
    projectId: "hopekcc-2024-summer-intern-api",
    storageBucket: "hopekcc-2024-summer-intern-api.appspot.com",
    messagingSenderId: "172531116306",
    appId: "1:172531116306:web:d898ae28b5f79a425babcb",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const form   = document.getElementById('songid-form');
  const input  = document.getElementById('song_id');
  const iframe = document.getElementById('pdf-frame');

  const escapeHtml = (s) =>
    String(s).replaceAll("&","&amp;")
             .replaceAll("<","&lt;")
             .replaceAll(">","&gt;")
             .replaceAll('"',"&quot;")
             .replaceAll("'","&#39;");

  function setNowLabel(id, title, artist) {
    const nowSong = document.getElementById('now-song');
    if (!nowSong) return;
    if (title || artist) {
      const t = escapeHtml(title || "Untitled");
      const a = escapeHtml(artist || "Unknown");
      nowSong.innerHTML = `${t} <span aria-hidden="true">–</span> <span style="opacity:.85">${a}</span>`;
    } else {
      nowSong.textContent = id || "—";
    }
  }

  async function waitForAuth() {
    await new Promise(resolve => {
      const unsub = onAuthStateChanged(auth, () => { unsub(); resolve(); });
    });
    return auth.currentUser;
  }

  // --- fetch helpers --------------------------------------------------------
  async function getJson(url, token) {
    const res = await fetch(url, {
      headers: token ? { Authorization: "Bearer " + token } : {}
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  async function fetchSongMeta(songId, token) {
    // Try common meta endpoints (adjust if you know the exact one)
    const id = encodeURIComponent(songId);
    const endpoints = [
      `http://34.125.143.141:8000/songs/${id}`,            // e.g. {id,title,artist,...}
      `/songs/${id}/meta`,       // e.g. {title,artist}
      `/songs/meta/${id}`,
      `/songs/detail/${id}`,
      `/songs/${id}/info`,
    ];
    for (const ep of endpoints) {
      try {
        const data = await getJson(ep, token);
        const obj = Array.isArray(data) ? data[0] : (data.data || data);
        if (!obj) continue;
        const title  = obj.title ?? obj.name ?? obj.song_title;
        const artist = obj.artist ?? obj.singer ?? obj.author ??
                       (Array.isArray(obj.artists) ? obj.artists.join(", ") : undefined);
        if (title || artist) return { title, artist };
      } catch (e) {
        // try next
      }
    }
    return {}; // fallback: nothing found
  }

  async function loadPdfWithToken(songId, meta = {}) {
    const user = await waitForAuth();
    if (!user) { alert("Please sign in first."); return; }

    const idToken = await user.getIdToken(true);

    // If no title/artist provided (manual ID case), fetch metadata
    if (!meta.title && !meta.artist) {
      try {
        const fetched = await fetchSongMeta(songId, idToken);
        if (fetched) meta = { ...meta, ...fetched };
      } catch (e) {
        // ignore, fall back to showing ID
      }
    }

    // Update label (Title – Artist if available)
    setNowLabel(songId, meta.title, meta.artist);

    // Set iframe to the PDF
    if (iframe) {
      iframe.src = `/songs/${encodeURIComponent(songId)}/pdf?token=${encodeURIComponent(idToken)}`;
    }

    // Keep URL in sync so refresh/share preserves meta when available
    const params = new URLSearchParams(window.location.search);
    params.set('song_id', songId);
    if (meta.title)  params.set('title',  meta.title);
    if (meta.artist) params.set('artist', meta.artist);
    history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
  }

  // Submit -> load without full page refresh
  if (form && input) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = input.value.trim();
      if (!id) return;
      await loadPdfWithToken(id); // will fetch meta automatically
    });
  }

  // If page opened with ?song_id=..., auto-load it
  const params   = new URLSearchParams(window.location.search);
  const initial  = params.get('song_id');
  const initialT = params.get('title');
  const initialA = params.get('artist');

  if (initial) {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadPdfWithToken(initial, { title: initialT, artist: initialA });
      } else {
        // show something while waiting for login
        setNowLabel(initial, initialT, initialA);
      }
    });
  }
</script>
{% endblock %}

