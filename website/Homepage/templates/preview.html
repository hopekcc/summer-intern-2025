{% extends 'base.html' %}

{% block title %}Preview Rendering{% endblock %}

{% block content %}
<div class="welcome-section">
  <div class="welcome-text">
    <h1>Song PDF Preview</h1>

    <!-- Search by song_id (GET ensures the URL shows ?song_id=...) -->
    <form id="songid-form" method="get" action="{{ url_for('preview') }}" style="margin-bottom:1rem;">
      <label for="song_id"><strong>Song ID</strong></label>
      <input
        type="text"
        id="song_id"
        name="song_id"
        placeholder="e.g. 12345, abcdef..."
        value="{{ request.args.get('song_id', '') }}"
        style="width:280px;margin-left:0.5rem;"
        required
      />
      <button type="submit" class="btn-primary" style="margin-left:0.5rem;">Show PDF</button>
    </form>

    <!-- (Optional) Keep your original ChordPro preview textarea if you still want it 
    <details style="margin:1rem 0;">
      <summary style="cursor:pointer;">Paste ChordPro (legacy preview)</summary>
      <form method="post" style="margin-top:0.75rem;">
        <textarea name="chordpro_text" rows="10" cols="60" placeholder="Paste your ChordPro content here..."></textarea>
        <br><br>
        <button type="submit" class="btn-primary">Render Preview</button>
      </form> -->
    </details>
  </div>
</div>

<!-- PDF Viewer -->
<div class="welcome-section">
  <div class="welcome-text">
    <h2>Preview Output</h2>

    {% set song_id = request.args.get('song_id') %}
    {% if song_id %}
      <p style="margin:0 0 0.5rem 0;">Now showing: <code>{{ song_id }}</code></p>
      <iframe
        id="pdf-frame"
        title="ChordPro PDF"
        width="100%"
        height="640"
        style="border:1px solid #e5e7eb;border-radius:8px;background:#fff"
        src="/songs/{{ song_id }}/pdf">
      </iframe>
      <p id="pdf-hint" style="color:#777;margin-top:0.5rem">
        If the PDF does not load, confirm the song ID exists and that <code>/songs/{{ song_id }}/pdf</code> is reachable.
      </p>
    {% else %}
      <p style="color:#777">Enter a song ID and click “Show PDF”.</p>
    {% endif %}

    {% if content %}
      <h3 style="margin-top:1.5rem;">Raw ChordPro Preview</h3>
      <pre style="background-color:#f0f0f0;padding:1rem;border-radius:5px;">{{ content }}</pre>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Optional enhancement: update the iframe without a full page reload
  const form = document.getElementById('songid-form');
  const input = document.getElementById('song_id');
  const iframe = document.getElementById('pdf-frame');

  if (form && input) {
    form.addEventListener('submit', function (e) {
      // If the iframe is already on the page, update it directly and also push state to URL
      if (iframe) {
        e.preventDefault();
        const id = input.value.trim();
        if (!id) return;

        const url = "{BACKEND_BASE}/songs/{song_id}/pdf";
        iframe.src = url;

        // Keep URL in sync so reloads/bookmarks work
        const params = new URLSearchParams(window.location.search);
        params.set('song_id', id);
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState({}, '', newUrl);
      }
    });
  }
</script>
{% endblock %}